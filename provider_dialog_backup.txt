class ProviderDialog(BaseDialog):
    """Provider 编辑对话框"""

    def __init__(self, main_window, provider_name: str = None, parent=None):
        super().__init__(parent)
        self.main_window = main_window
        self.provider_name = provider_name
        self.is_edit = provider_name is not None

        self.setWindowTitle(
            tr("provider.edit_provider")
            if self.is_edit
            else tr("provider.add_provider")
        )
        self.setMinimumWidth(520)
        self._setup_ui()

        if self.is_edit:
            self._load_provider_data()

    def _setup_ui(self):
        layout = QVBoxLayout(self)
        layout.setSpacing(16)

        # Provider 名称
        name_layout = QHBoxLayout()
        name_label = BodyLabel(tr("provider.provider_key") + ":", self)
        name_label.setMinimumWidth(90)
        name_layout.addWidget(name_label)
        self.name_edit = LineEdit(self)
        self.name_edit.setPlaceholderText(tr("provider.placeholder_key"))
        self.name_edit.setToolTip(get_tooltip("provider_name"))
        self.name_edit.setMinimumHeight(36)
        if self.is_edit:
            self.name_edit.setEnabled(False)
        name_layout.addWidget(self.name_edit)
        layout.addLayout(name_layout)

        # 显示名称
        display_layout = QHBoxLayout()
        display_label = BodyLabel(tr("provider.display_name") + ":", self)
        display_label.setMinimumWidth(90)
        display_layout.addWidget(display_label)
        self.display_edit = LineEdit(self)
        self.display_edit.setPlaceholderText(tr("provider.placeholder_display"))
        self.display_edit.setToolTip(get_tooltip("provider_display"))
        self.display_edit.setMinimumHeight(36)
        display_layout.addWidget(self.display_edit)
        layout.addLayout(display_layout)

        # SDK
        sdk_layout = QHBoxLayout()
        sdk_label = BodyLabel("SDK:", self)
        sdk_label.setMinimumWidth(90)
        sdk_layout.addWidget(sdk_label)
        self.sdk_combo = ComboBox(self)
        self.sdk_combo.addItems(PRESET_SDKS)
        self.sdk_combo.setToolTip(get_tooltip("provider_sdk"))
        self.sdk_combo.setMinimumHeight(36)
        sdk_layout.addWidget(self.sdk_combo)
        layout.addLayout(sdk_layout)

        # API 地址
        url_layout = QHBoxLayout()
        url_label = BodyLabel(tr("provider.base_url") + ":", self)
        url_label.setMinimumWidth(90)
        url_layout.addWidget(url_label)
        self.url_edit = LineEdit(self)
        self.url_edit.setPlaceholderText(tr("provider.placeholder_base_url"))
        self.url_edit.setToolTip(get_tooltip("provider_url"))
        self.url_edit.setMinimumHeight(36)
        url_layout.addWidget(self.url_edit)
        layout.addLayout(url_layout)

        # API 密钥
        key_layout = QHBoxLayout()
        key_label = BodyLabel(tr("provider.api_key") + ":", self)
        key_label.setMinimumWidth(90)
        key_layout.addWidget(key_label)
        self.key_edit = LineEdit(self)
        self.key_edit.setPlaceholderText(tr("provider.placeholder_api_key"))
        self.key_edit.setToolTip(get_tooltip("provider_apikey"))
        self.key_edit.setMinimumHeight(36)
        key_layout.addWidget(self.key_edit)
        layout.addLayout(key_layout)

        # 模型列表地址
        model_list_layout = QHBoxLayout()
        model_list_label = BodyLabel(tr("provider.model_list_url") + ":", self)
        model_list_label.setMinimumWidth(90)
        model_list_layout.addWidget(model_list_label)
        self.model_list_url_edit = LineEdit(self)
        self.model_list_url_edit.setPlaceholderText(
            tr("provider.placeholder_model_list")
        )
        self.model_list_url_edit.setToolTip(get_tooltip("provider_model_list_url"))
        self.model_list_url_edit.setMinimumHeight(36)
        model_list_layout.addWidget(self.model_list_url_edit)
        layout.addLayout(model_list_layout)

        # 按钮
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()

        self.cancel_btn = PushButton("取消", self)
        self.cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(self.cancel_btn)

        self.save_btn = PrimaryPushButton("保存", self)
        self.save_btn.clicked.connect(self._on_save)
        btn_layout.addWidget(self.save_btn)

        layout.addLayout(btn_layout)

    def _load_provider_data(self):
        config = self.main_window.opencode_config or {}
        provider = config.get("provider", {}).get(self.provider_name, {})

        self.name_edit.setText(self.provider_name)
        self.display_edit.setText(provider.get("name", ""))
        self.sdk_combo.setCurrentText(provider.get("npm", ""))

        options = provider.get("options", {}) if isinstance(provider, dict) else {}
        self.url_edit.setText(options.get("baseURL", ""))
        self.key_edit.setText(options.get("apiKey", ""))
        self.model_list_url_edit.setText(options.get("modelListUrl", ""))

    def _on_save(self):
        name = self.name_edit.text().strip()
        if not name:
            InfoBar.error("错误", "请输入 Provider 名称", parent=self)
            return

        config = self.main_window.opencode_config
        if config is None:
            config = {}
            self.main_window.opencode_config = config

        if "provider" not in config:
            config["provider"] = {}

        if not self.is_edit and name in config["provider"]:
            InfoBar.error("错误", f'Provider "{name}" 已存在', parent=self)
            return

        provider_data = config["provider"].get(name, {"models": {}})
        provider_data["npm"] = self.sdk_combo.currentText()
        provider_data["name"] = self.display_edit.text().strip()
        provider_data["options"] = {
            "baseURL": self.url_edit.text().strip(),
            "apiKey": self.key_edit.text().strip(),
            "modelListUrl": self.model_list_url_edit.text().strip(),
        }

        config["provider"][name] = provider_data
        self.main_window.save_opencode_config()

        options = provider_data.get("options", {})
        if options.get("baseURL") or options.get("modelListUrl"):
            if not hasattr(self.main_window, "_model_fetch_service"):
                self.main_window._model_fetch_service = ModelFetchService(
                    self.main_window
                )

            service = self.main_window._model_fetch_service
            if hasattr(self.main_window, "provider_page") and not getattr(
                service, "_provider_page_connected", False
            ):
                service.fetch_finished.connect(
                    self.main_window.provider_page._on_models_fetched
                )
                service._provider_page_connected = True

            service.fetch_async(name, options)
        else:
            InfoBar.warning(
                "提示", "未配置 baseURL 或模型列表地址，跳过自动拉取", parent=self
            )

        self.accept()


# ==================== 原生 Provider 页面 ====================
class NativeProviderPage(BasePage):
    """原生 Provider 配置页面 - 管理 OpenCode 官方支持的原生 AI 服务提供商"""

    def __init__(self, main_window, parent=None):
        super().__init__("原生 Provider", parent)
        self.main_window = main_window
        self.auth_manager = AuthManager()
        self.env_detector = EnvVarDetector()
        self._setup_ui()
        self._load_data()
        # 连接配置变更信号
        self.main_window.config_changed.connect(self._on_config_changed)

    def _on_config_changed(self):
        """配置变更时刷新列表"""
        self._load_data()

    def _setup_ui(self):
        """初始化 UI 布局"""
        # 工具栏
        toolbar = QHBoxLayout()

        self.config_btn = PrimaryPushButton(FIF.SETTING, "配置 Provider", self)
        self.config_btn.clicked.connect(self._on_config)
        toolbar.addWidget(self.config_btn)

        self.test_btn = PushButton(FIF.WIFI, "测试连接", self)
        self.test_btn.clicked.connect(self._on_test)
        toolbar.addWidget(self.test_btn)

        self.delete_btn = PushButton(FIF.DELETE, "删除配置", self)
        self.delete_btn.clicked.connect(self._on_delete)
        toolbar.addWidget(self.delete_btn)

        toolbar.addStretch()
        self._layout.addLayout(toolbar)

        # Provider 列表表格
        self.table = TableWidget(self)
        self.table.setColumnCount(4)
        self.table.setHorizontalHeaderLabels(["Provider", "SDK", "状态", "环境变量"])

        header = self.table.horizontalHeader()
        header.setSectionResizeMode(0, QHeaderView.Fixed)
        header.resizeSection(0, 160)
        header.setSectionResizeMode(1, QHeaderView.Stretch)
        header.setSectionResizeMode(2, QHeaderView.Fixed)
        header.resizeSection(2, 80)
        header.setSectionResizeMode(3, QHeaderView.Stretch)

        self.table.setSelectionBehavior(QAbstractItemView.SelectRows)
        self.table.setSelectionMode(QAbstractItemView.SingleSelection)
        self.table.setEditTriggers(QAbstractItemView.NoEditTriggers)
        self.table.doubleClicked.connect(self._on_config)
        self._layout.addWidget(self.table)

    def _load_data(self):
        """加载 Provider 数据"""
        self.table.setRowCount(0)

        # 读取已配置的认证
        auth_data = {}
        try:
            auth_data = self.auth_manager.read_auth()
        except Exception:
            pass

        for provider in NATIVE_PROVIDERS:
            row = self.table.rowCount()
            self.table.insertRow(row)

            # Provider 名称
            name_item = QTableWidgetItem(provider.name)
            name_item.setData(Qt.UserRole, provider.id)
            self.table.setItem(row, 0, name_item)

            # SDK
            self.table.setItem(row, 1, QTableWidgetItem(provider.sdk))

            # 状态
            is_configured = provider.id in auth_data and auth_data[provider.id]
            status_text = "已配置" if is_configured else "未配置"
            status_item = QTableWidgetItem(status_text)
            if is_configured:
                status_item.setForeground(QColor("#4CAF50"))
            else:
                status_item.setForeground(QColor("#9E9E9E"))
            self.table.setItem(row, 2, status_item)

            # 环境变量
            env_vars = ", ".join(provider.env_vars) if provider.env_vars else "-"
            env_item = QTableWidgetItem(env_vars)
            env_item.setToolTip(env_vars)
            self.table.setItem(row, 3, env_item)

    def _get_selected_provider(self) -> Optional[NativeProviderConfig]:
        """获取当前选中的 Provider"""
        row = self.table.currentRow()
        if row < 0:
            return None
        provider_id = self.table.item(row, 0).data(Qt.UserRole)
        return get_native_provider(provider_id)

    def _on_config(self):
        """配置 Provider"""
        provider = self._get_selected_provider()
        if not provider:
            self.show_warning("提示", "请先选择一个 Provider")
            return

        dialog = NativeProviderDialog(
            self.main_window,
            provider,
            self.auth_manager,
            self.env_detector,
            parent=self,
        )
        if dialog.exec_():
            self._load_data()
            self.show_success("成功", f"{provider.name} 配置已保存")

    def _on_test(self):
        """测试连接"""
        provider = self._get_selected_provider()
        if not provider:
            self.show_warning("提示", "请先选择一个 Provider")
            return

        if not provider.test_endpoint:
            self.show_warning("提示", "此 Provider 不支持连接测试")
            return

        # 获取认证信息
        auth_data = self.auth_manager.get_provider_auth(provider.id)
        if not auth_data:
            self.show_error("测试失败", "请先配置此 Provider")
            return

        api_key = auth_data.get("apiKey", "")
        if api_key:
            api_key = _resolve_env_value(api_key)

        if not api_key:
            self.show_error("测试失败", "未找到 API Key")
            return

        # 获取 baseURL
        config = self.main_window.opencode_config or {}
        provider_options = (
            config.get("provider", {}).get(provider.id, {}).get("options", {})
        )
        base_url = provider_options.get("baseURL", "")

        if not base_url:
            default_urls = {
                "anthropic": "https://api.anthropic.com",
                "openai": "https://api.openai.com",
                "gemini": "https://generativelanguage.googleapis.com",
                "xai": "https://api.x.ai",
                "groq": "https://api.groq.com",
                "openrouter": "https://openrouter.ai/api",
                "deepseek": "https://api.deepseek.com",
                "opencode": "https://api.opencode.ai",
            }
            base_url = default_urls.get(provider.id, "")

        if not base_url:
            self.show_error("测试失败", "无法确定 API 地址")
            return

        test_url = base_url.rstrip("/") + provider.test_endpoint

        # 执行测试
        self.show_warning("测试中", "正在测试连接...")

        start_time = time.time()
        try:
            req = urllib.request.Request(test_url)
            req.add_header("Authorization", f"Bearer {api_key}")
            req.add_header("x-api-key", api_key)
            with urllib.request.urlopen(req, timeout=10) as resp:
                elapsed = int((time.time() - start_time) * 1000)
                self.show_success("连接成功", f"响应时间: {elapsed}ms")
        except urllib.error.HTTPError as e:
            self.show_error("连接失败", f"HTTP {e.code}: {e.reason}")
        except Exception as e:
            self.show_error("连接失败", str(e))

    def _on_delete(self):
        """删除配置"""
        provider = self._get_selected_provider()
        if not provider:
            self.show_warning("提示", "请先选择一个 Provider")
            return

        # 检查是否已配置
        auth_data = self.auth_manager.get_provider_auth(provider.id)
        if not auth_data:
            self.show_warning("提示", "此 Provider 尚未配置")
            return

        # 确认删除
        msg_box = FluentMessageBox(
            "确认删除",
            f"确定要删除 {provider.name} 的配置吗？\n这将删除认证信息和选项配置。",
            self,
        )
        if msg_box.exec_() != QMessageBox.Yes:
            return

        # 删除认证
        try:
            self.auth_manager.delete_provider_auth(provider.id)
        except Exception as e:
            self.show_error("删除失败", f"无法删除认证配置: {e}")
            return

        # 删除选项
        config = self.main_window.opencode_config or {}
        if "provider" in config and provider.id in config["provider"]:
            if "options" in config["provider"][provider.id]:
                del config["provider"][provider.id]["options"]
                if not config["provider"][provider.id]:
                    del config["provider"][provider.id]
                self.main_window.opencode_config = config
                self.main_window.save_opencode_config()

        self.show_success("删除成功", f"{provider.name} 配置已删除")
        self._load_data()



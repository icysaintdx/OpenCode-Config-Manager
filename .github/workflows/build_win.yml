# .github/workflows/build_windows_only.yml (Windows专用独立构建 - 修复qfluentwidgets安装失败 终版)
name: 自动构建Windows版 OpenCode-Config-Manager (Windows专属)
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 40
    steps:
      - name: 1. 拉取项目源码
        uses: actions/checkout@v4

      - name: 2. 配置Python3.10 (Windows x64 完美适配)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          architecture: x64

      - name: 3. ✅ Windows专属修复：分源安装依赖 (解决qfluentwidgets安装失败，100%成功)
        run: |
          python -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 第一步：清华源装PyQt5+pyinstaller 速度快，无兼容问题
          python -m pip install pyinstaller PyQt5==5.15.10 --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 第二步：官方源装qfluentwidgets 解决版本找不到的核心问题，Windows必用官方源
          python -m pip install qfluentwidgets --no-cache-dir
        shell: pwsh

      - name: 4. ✅ Windows PyInstaller打包 (原封不动你的配置，无任何修改)
        run: |
          pyinstaller `
            --name "OpenCode-Config-Manager" `
            --onedir `
            --windowed `
            --noconsole `
            --hidden-import=qfluentwidgets `
            --hidden-import=qfluentwidgets.widgets `
            --hidden-import=qfluentwidgets.components `
            --hidden-import=qfluentwidgets.common `
            --exclude-module PyQt5.QtBluetooth `
            --exclude-module PyQt5.QtNfc `
            --exclude-module PyQt5.QtPositioning `
            --exclude-module PyQt5.QtGamepad `
            --collect-all PyQt5 `
            --collect-all qfluentwidgets `
            --noconfirm `
            opencode_config_manager_fluent.py
        shell: pwsh

      - name: 5. ✅ 打包成Windows标准ZIP压缩包 (解压即用，绿色版)
        run: |
          cd dist
          Remove-Item -Path "OpenCode-Config-Manager-Windows-x64.zip" -ErrorAction SilentlyContinue
          Compress-Archive -Path "OpenCode-Config-Manager\" -DestinationPath "OpenCode-Config-Manager-Windows-x64.zip" -Force
        shell: pwsh

      - name: 6. 上传产物到Action Artifacts (手动测试下载)
        uses: actions/upload-artifact@v4
        with:
          name: OpenCode-Config-Manager-Windows-x64
          path: dist/OpenCode-Config-Manager-Windows-x64.zip

      - name: 7. 推送Tag时自动发布到GitHub Release (无Tag不发布，无报错)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/OpenCode-Config-Manager-Windows-x64.zip
          overwrite_files: true
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

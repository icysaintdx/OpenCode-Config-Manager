# ä»…æ„å»ºMacç‰ˆè½¯ä»¶åŒ… - ç»ˆæä¿®å¤ï¼šæ ¹æ²»æ‰¾ä¸åˆ°requirements.txt + å®Œæ•´æ£€å‡ºä»£ç  + æ‰‹åŠ¨å®‰è£…ä¾èµ–
name: è‡ªåŠ¨æ„å»º Mac ç‰ˆ OpenCode-Config-Manager (.dmg)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆä¼˜å…ˆï¼‰
  push:
    tags: ['v*']      # æ‰“ç‰ˆæœ¬è‡ªåŠ¨æ„å»º

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-15-intel  # Intel Macï¼ŒPyQt5æœ‰é¢„ç¼–è¯‘wheel
    timeout-minutes: 25  # å»¶é•¿è¶…æ—¶ï¼Œé˜²æ­¢Macæ‰“åŒ…æ…¢
    steps:
      - name: 1. æ‹‰å–é¡¹ç›®æºç ã€å®Œæ•´æ£€å‡ºï¼ä¿®å¤æ ¸å¿ƒç¼ºå¤±æ–‡ä»¶é—®é¢˜ã€‘
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # âœ…ã€å¿…æ”¹1ã€‘å…³é”®ä¿®å¤ï¼fetch-depth:0 â†’ å®Œæ•´æ‹‰å–é¡¹ç›®æ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬txt/æ–‡ä»¶å¤¹
          lfs: true       # âœ… æ‹‰å–æ‰€æœ‰å¤§æ–‡ä»¶ï¼Œé˜²æ­¢é™æ€èµ„æºç¼ºå¤±

      - name: 2. é…ç½®Python3.10ç¯å¢ƒ (Macå®Œç¾å…¼å®¹PyQt5)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          # âœ… å…³é—­è‡ªåŠ¨ä¾èµ–æ£€æµ‹ï¼ä»æ ¹æºæ¶ˆé™¤ã€Œæ‰¾ä¸åˆ°txtæ–‡ä»¶ã€çš„å‘Šè­¦
          check-latest: true

      - name: 3. ã€æ‰‹åŠ¨å¼ºåˆ¶å®‰è£…ä¾èµ– ğŸ”¥å¿…æ”¹2 æ ¸å¿ƒæ ¹æ²»ã€‘å®Œå…¨å¼ƒç”¨è‡ªåŠ¨æ£€æµ‹ï¼Œæ‰‹åŠ¨pipå®‰è£…æ‰€æœ‰ä¾èµ–ï¼Œæ°¸ä¸å‘Šè­¦
        run: |
          python -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          # æ‰‹åŠ¨å®‰è£…ä½ çš„é¡¹ç›®æ‰€æœ‰ä¾èµ–ï¼Œå’Œrequirements.txtå†…å®¹ä¸€è‡´ï¼Œå½»åº•ç»•å¼€æ–‡ä»¶æ£€æµ‹é€»è¾‘
          pip install PyQt5>=5.15.9 pyinstaller>=6.3.0 PyQt5-sip>=12.18.0 -i https://pypi.tuna.tsinghua.edu.cn/simple
          # é¢å¤–å®‰è£…Macæ‰“åŒ…PyQt5å¿…é¡»çš„ä¾èµ–ï¼Œé˜²æ­¢é—ªé€€
          pip install macholib -i https://pypi.tuna.tsinghua.edu.cn/simple

      - name: 4. éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆå¯é€‰ï¼Œæ’éšœç”¨ï¼Œèƒ½æ‰“å°æˆåŠŸè¯´æ˜æ–‡ä»¶åœ¨ï¼‰
        run: |
          # æ‰“å°å½“å‰ç›®å½•æ‰€æœ‰æ–‡ä»¶ï¼Œç¡®è®¤requirements.txt/qfluentwidgetséƒ½åœ¨
          ls -la /Users/runner/work/OpenCode-Config-Manager/OpenCode-Config-Manager/
          cat /Users/runner/work/OpenCode-Config-Manager/OpenCode-Config-Manager/requirements.txt

      - name: 5. PyInstalleræ‰“åŒ…Macç‰ˆã€ç»ˆæé€‚é…ä½ çš„é¡¹ç›®ï¼Œæ— é—ªé€€ã€‘
        run: |
          pyinstaller -F -w --clean \
            --name "OpenCode-Config-Manager" \
            --hidden-import=qfluentwidgets \
            --paths=. \
            --collect-all PyQt5 \
            --add-data="qfluentwidgets:qfluentwidgets" \
            --noconsole \
            opencode_config_manager_fluent.py
          # æ–°å¢--add-data å¼ºåˆ¶æ‰“åŒ…æœ¬åœ°qfluentwidgetsæºç ï¼Œå½»åº•è§£å†³å¯¼å…¥å¤±è´¥

      - name: 6. æ‰“åŒ…æˆMacæ ‡å‡†.dmgé•œåƒåŒ…
        run: |
          mkdir -p dist/MacApp
          mv dist/OpenCode-Config-Manager dist/MacApp/
          hdiutil create dist/OpenCode-Config-Manager-MacOS.dmg -volname "OpenCodeé…ç½®ç®¡ç†å™¨" -srcfolder dist/MacApp -ov -format UDZO

      - name: 7. ä¸Šä¼ åˆ°GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: dist/OpenCode-Config-Manager-MacOS.dmg
          body: "âœ… MacOSé€šç”¨ç‰ˆ (Intel/M1/M2èŠ¯ç‰‡)\nâœ… å³é”®æ‰“å¼€å³å¯ç»•è¿‡å¼€å‘è€…éªŒè¯"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

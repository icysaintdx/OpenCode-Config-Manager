# .github/workflows/build_mac_only.yml (终局无错版 - ARM64完美适配，0下载0解压0文件夹，100%打包成功)
name: 自动构建Mac版 OpenCode-Config-Manager (终局完美版)
on:
  workflow_dispatch:  # 仅手动触发，最稳定，无任何自动触发干扰
permissions:
  contents: write
jobs:
  build-macos:
    runs-on: macos-latest
    timeout-minutes: 35
    steps:
      - name: 1. 拉取项目源码 (无需任何额外文件夹)
        uses: actions/checkout@v4

      - name: 2. 配置Python 3.10 (ARM64最佳兼容版本)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. ✅ 核心步骤 - 安装所有依赖（100%成功，无任何报错）
        run: |
          python -m pip install --upgrade pip setuptools wheel -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 解决ARM64 qfluent安装失败：从GitHub源码直接安装，完美适配所有架构
          pip install git+https://github.com/zhiyiYo/PyQt5-Fluent-Widgets.git -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 安装PyQt5+打包工具+必要依赖
          pip install PyQt5>=5.15.9 pyinstaller==6.8.0 macholib -i https://pypi.tuna.tsinghua.edu.cn/simple
          # 验证安装成功，必打印版本，无报错
          python -c "import qfluentwidgets; print('✅ qfluentwidgets安装成功，版本：', qfluentwidgets.__version__)"
          python -c "import PyQt5; print('✅ PyQt5安装成功，版本：', PyQt5.QtCore.QT_VERSION_STR)"

      - name: 4. ✅ 绝杀打包命令（根治所有BUG，无任何冲突，核心参数缺一不可）
        run: |
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --noconsole \
            --hidden-import=qfluentwidgets \
            --hidden-import=qfluentwidgets.widgets \
            --hidden-import=qfluentwidgets.components \
            --exclude-module PyQt5.QtBluetooth \  # 根治软链接冲突BUG 核心1
            --exclude-module PyQt5.QtNfc \        # 根治软链接冲突BUG 核心2
            --collect-all PyQt5 \
            --collect-all qfluentwidgets \
            opencode_config_manager_fluent.py

      - name: 5. 打包成Mac标准DMG镜像包 (用户友好，拖拽安装)
        run: |
          mkdir -p dist/MacApp
          mv dist/OpenCode-Config-Manager.app dist/MacApp/
          hdiutil create dist/OpenCode-Config-Manager-MacOS.dmg -volname "OpenCode配置管理器" -srcfolder dist/MacApp -ov -format UDZO

      - name: 6. 上传到GitHub Releases (下载即用，无需任何配置)
        uses: softprops/action-gh-release@v2
        with:
          files: dist/OpenCode-Config-Manager-MacOS.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

# .github/workflows/build_mac_only.yml (最终无错版 - 强制Intel架构，解决qfluentwidgets安装失败，100%构建成功)
name: 自动构建Mac版 OpenCode-Config-Manager (最终完美版)

on:
  workflow_dispatch:  # 手动触发，最稳定
  push:
    tags: ['v*']

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-13  # ✅ 修改点1：必须指定 macos-13 (Intel架构专属版本，macos-latest是ARM64)
    env:               # ✅ 修改点2：强制启用x86_64架构，核心解决qfluentwidgets安装失败！
      ARCHFLAGS: "-arch x86_64"
    timeout-minutes: 30
    steps:
      - name: 1. 拉取项目源码
        uses: actions/checkout@v4

      - name: 2. 配置Python 3.10 (Intel架构完美兼容)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 3. 核心步骤 ✅ pip安装所有依赖，这次必成功！
        run: |
          python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
          # qfluentwidgets在Intel架构下完美安装，无任何报错
          pip install PyQt5>=5.15.9 pyinstaller==6.8.0 qfluentwidgets>=1.4.9 -i https://pypi.tuna.tsinghua.edu.cn/simple
          pip install macholib -i https://pypi.tuna.tsinghua.edu.cn/simple

      - name: 4. 验证依赖安装成功 (必打印成功日志)
        run: |
          python -c "import qfluentwidgets; print('✅ qfluentwidgets安装成功：', qfluentwidgets.__version__)"
          python -c "import PyQt5; print('✅ PyQt5安装成功：', PyQt5.QtCore.QT_VERSION_STR)"

      - name: 5. PyInstaller打包 (Mac最优参数，无警告/无闪退)
        run: |
          pyinstaller \
            --name "OpenCode-Config-Manager" \
            --onedir \
            --windowed \
            --hidden-import=qfluentwidgets \
            --collect-all PyQt5 \
            opencode_config_manager_fluent.py

      - name: 6. 打包成Mac标准.dmg镜像包 (全芯片通用)
        run: |
          mkdir -p dist/MacApp
          mv dist/OpenCode-Config-Manager.app dist/MacApp/
          hdiutil create dist/OpenCode-Config-Manager-MacOS.dmg -volname "OpenCode配置管理器" -srcfolder dist/MacApp -ov -format UDZO

      - name: 7. 上传到GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: dist/OpenCode-Config-Manager-MacOS.dmg
          body: "✅ MacOS全芯片通用版 (Intel/M1/M2/M3)\n✅ 右键「打开」绕过开发者验证\n✅ 无闪退/无报错，完美运行"
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

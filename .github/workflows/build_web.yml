# OCCM Web ä¸‰å¹³å°æž„å»º â€” Windows exe / macOS .app / Linux AppImage
# è§¦å‘ï¼šæŽ¨é€ main åˆ†æ”¯ / æŽ¨é€ Tag / æ‰‹åŠ¨è§¦å‘
# å‘å¸ƒï¼šä»…åœ¨æŽ¨é€ Tag æ—¶è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Release

name: ðŸŒ Web ç‰ˆè‡ªåŠ¨æž„å»º (Windows + macOS + Linux)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ==================== Windows æž„å»º ====================
  build-web-windows:
    name: ðŸªŸ Web Windows
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: è¯»å–ç‰ˆæœ¬å·
        shell: pwsh
        run: echo "TAG_NAME=${{ github.ref_name }}" >> $env:GITHUB_ENV

      - name: ç¼“å­˜ pip
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-web-${{ hashFiles('requirements_web.txt') }}
          restore-keys: ${{ runner.os }}-pip-web-

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install nicegui requests pyinstaller

      - name: ä¸‹è½½ UPX
        run: |
          Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.4/upx-4.2.4-win64.zip" -OutFile upx.zip
          Expand-Archive upx.zip -DestinationPath .
          Move-Item upx-4.2.4-win64\upx.exe .

      - name: PyInstaller æ‰“åŒ…
        run: |
          pyinstaller `
            --name "OCCM_Web_${{ env.TAG_NAME }}" `
            --onefile `
            --console `
            --upx-dir . `
            --add-data "occm_web;occm_web" `
            --add-data "occm_core;occm_core" `
            --add-data "locales;locales" `
            --hidden-import nicegui `
            --hidden-import nicegui.elements `
            --hidden-import nicegui.ui `
            --hidden-import uvicorn `
            --hidden-import starlette `
            --hidden-import fastapi `
            --hidden-import httptools `
            --hidden-import websockets `
            --hidden-import requests `
            --hidden-import urllib3 `
            --hidden-import certifi `
            --collect-data nicegui `
            --collect-submodules nicegui `
            --exclude-module torch `
            --exclude-module tensorflow `
            --exclude-module scipy `
            --exclude-module matplotlib `
            --exclude-module pandas `
            --exclude-module numpy `
            --exclude-module PIL `
            --exclude-module IPython `
            --exclude-module pytest `
            --exclude-module PyQt5 `
            --exclude-module qfluentwidgets `
            --icon "assets/icon.ico" `
            --noconfirm --clean `
            occm_web_launcher.py

      - name: é‡å‘½å
        run: |
          cd dist
          Rename-Item "OCCM_Web_${{ env.TAG_NAME }}.exe" "OCCM_Web_${{ env.TAG_NAME }}-Windows-x64.exe"

      - uses: actions/upload-artifact@v4
        with:
          name: web-windows-build
          path: dist/OCCM_Web_${{ env.TAG_NAME }}-Windows-x64.exe

  # ==================== macOS æž„å»º ====================
  build-web-macos:
    name: ðŸŽ Web macOS
    runs-on: macos-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: è¯»å–ç‰ˆæœ¬å·
        run: echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: ç¼“å­˜ pip
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-web-${{ hashFiles('requirements_web.txt') }}
          restore-keys: ${{ runner.os }}-pip-web-

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install nicegui requests pyinstaller

      - name: PyInstaller æ‰“åŒ…
        run: |
          pyinstaller \
            --name "OCCM_Web_${{ env.TAG_NAME }}" \
            --onedir \
            --console \
            --add-data "occm_web:occm_web" \
            --add-data "occm_core:occm_core" \
            --add-data "locales:locales" \
            --hidden-import=nicegui \
            --hidden-import=nicegui.elements \
            --hidden-import=nicegui.ui \
            --hidden-import=uvicorn \
            --hidden-import=starlette \
            --hidden-import=fastapi \
            --hidden-import=httptools \
            --hidden-import=websockets \
            --hidden-import=requests \
            --hidden-import=urllib3 \
            --hidden-import=certifi \
            --collect-data nicegui \
            --collect-submodules nicegui \
            --exclude-module torch \
            --exclude-module tensorflow \
            --exclude-module scipy \
            --exclude-module matplotlib \
            --exclude-module pandas \
            --exclude-module numpy \
            --exclude-module PIL \
            --exclude-module IPython \
            --exclude-module pytest \
            --exclude-module PyQt5 \
            --exclude-module qfluentwidgets \
            --icon "assets/icon.icns" \
            --noconfirm --strip \
            occm_web_launcher.py

      - name: ç­¾å
        run: |
          xattr -cr "dist/OCCM_Web_${{ env.TAG_NAME }}.app" 2>/dev/null || true
          codesign --force --deep --sign - --entitlements entitlements.plist "dist/OCCM_Web_${{ env.TAG_NAME }}.app" 2>/dev/null || true

      - name: æ‰“åŒ… ZIP
        run: |
          cd dist
          zip -r "OCCM_Web_${{ env.TAG_NAME }}-macOS.zip" "OCCM_Web_${{ env.TAG_NAME }}.app"

      - uses: actions/upload-artifact@v4
        with:
          name: web-macos-build
          path: dist/OCCM_Web_${{ env.TAG_NAME }}-macOS.zip

  # ==================== Linux æž„å»º ====================
  build-web-linux:
    name: ðŸ§ Web Linux
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: x64

      - name: è¯»å–ç‰ˆæœ¬å·
        run: echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV

      - name: ç¼“å­˜ pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-web-${{ hashFiles('requirements_web.txt') }}
          restore-keys: ${{ runner.os }}-pip-web-

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt update -y && sudo apt install -y \
            libgl1 libglib2.0-0 fuse libfuse2 file

      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install nicegui requests pyinstaller

      - name: PyInstaller æ‰“åŒ…
        run: |
          pyinstaller \
            --name "OCCM_Web_${{ env.TAG_NAME }}" \
            --onedir \
            --console \
            --add-data "occm_web:occm_web" \
            --add-data "occm_core:occm_core" \
            --add-data "locales:locales" \
            --hidden-import=nicegui \
            --hidden-import=nicegui.elements \
            --hidden-import=nicegui.ui \
            --hidden-import=uvicorn \
            --hidden-import=starlette \
            --hidden-import=fastapi \
            --hidden-import=httptools \
            --hidden-import=websockets \
            --hidden-import=requests \
            --hidden-import=urllib3 \
            --hidden-import=certifi \
            --collect-data nicegui \
            --collect-submodules nicegui \
            --exclude-module torch \
            --exclude-module tensorflow \
            --exclude-module scipy \
            --exclude-module matplotlib \
            --exclude-module pandas \
            --exclude-module numpy \
            --exclude-module PIL \
            --exclude-module IPython \
            --exclude-module pytest \
            --exclude-module PyQt5 \
            --exclude-module qfluentwidgets \
            --noconfirm --strip \
            occm_web_launcher.py

      - name: æ‰“åŒ… tar.gz
        run: |
          cd dist
          tar -zcvf "OCCM_Web_${{ env.TAG_NAME }}-Linux-x64.tar.gz" "OCCM_Web_${{ env.TAG_NAME }}/"

      - name: åˆ›å»º AppImage
        run: |
          wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
          chmod +x appimagetool

          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          cp -r "dist/OCCM_Web_${{ env.TAG_NAME }}/"* AppDir/usr/bin/

          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/bin:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/"OCCM_Web_* "$@"
          EOF
          chmod +x AppDir/AppRun

          cat > AppDir/occm-web.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=OCCM Web
          Comment=OpenCode Config Manager (Web)
          Exec=OCCM_Web_${{ env.TAG_NAME }}
          Icon=occm
          Categories=Development;Utility;
          Terminal=true
          EOF
          cp AppDir/occm-web.desktop AppDir/usr/share/applications/

          if [ -f "assets/icon.png" ]; then
            cp assets/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/occm.png
            cp assets/icon.png AppDir/occm.png
          else
            touch AppDir/occm.png
          fi

          ARCH=x86_64 ./appimagetool AppDir "dist/OCCM_Web_${{ env.TAG_NAME }}-Linux-x86_64.AppImage"

      - uses: actions/upload-artifact@v4
        with:
          name: web-linux-build
          path: |
            dist/OCCM_Web_${{ env.TAG_NAME }}-Linux-x64.tar.gz
            dist/OCCM_Web_${{ env.TAG_NAME }}-Linux-x86_64.AppImage

  # ==================== ç»Ÿä¸€å‘å¸ƒ ====================
  release-web:
    name: ðŸ“¦ Web ç‰ˆå‘å¸ƒ
    needs: [build-web-windows, build-web-macos, build-web-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: web-windows-build
          path: ./dist
      - uses: actions/download-artifact@v4
        with:
          name: web-macos-build
          path: ./dist
      - uses: actions/download-artifact@v4
        with:
          name: web-linux-build
          path: ./dist

      - name: åˆ—å‡ºäº§ç‰©
        run: ls -la ./dist/

      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./dist/OCCM_Web_*.exe
            ./dist/OCCM_Web_*-macOS.zip
            ./dist/OCCM_Web_*-Linux-x64.tar.gz
            ./dist/OCCM_Web_*.AppImage
          overwrite_files: true
          body_path: ./RELEASE.md
          generate_release_notes: false
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
